<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Nginx启用HTTPS和HTTP/2 | 晴天</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx启用HTTPS和HTTP/2</h1><a id="logo" href="/."><img class="nofancybox" src="/images/qingtian.svg" width="85"></a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx启用HTTPS和HTTP/2</h1><div class="post-meta">Oct 27, 2016<span> | </span><span class="category"><a href="/categories/websites/">网站</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要用HTTPS"><span class="toc-number">1.</span> <span class="toc-text">为什么要用HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CA的证书"><span class="toc-number">2.</span> <span class="toc-text">CA的证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#具体步骤"><span class="toc-number">3.</span> <span class="toc-text">具体步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装客户端"><span class="toc-number">3.1.</span> <span class="toc-text">安装客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成证书"><span class="toc-number">3.2.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Nginx"><span class="toc-number">3.3.</span> <span class="toc-text">配置Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开启HTTP-2"><span class="toc-number">3.4.</span> <span class="toc-text">开启HTTP/2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置防火墙"><span class="toc-number">3.5.</span> <span class="toc-text">配置防火墙</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置crontab"><span class="toc-number">3.6.</span> <span class="toc-text">配置crontab</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后续处理"><span class="toc-number">4.</span> <span class="toc-text">后续处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="post-content"><h3 id="为什么要用HTTPS"><a href="#为什么要用HTTPS" class="headerlink" title="为什么要用HTTPS"></a>为什么要用HTTPS</h3><p>HTTP直接用明文传输，所以非常不安全，在传输过程中数据很容易被窥探甚至串改，比如国内某些网络运营商就经常靠这种方式推送广告，特别烦人。为了防止这个问题，便有了SSL，原理简单的说就是，服务器和客户端之间传输数据前先进行加密，到了对方那再进行解密，那么在传输的过程中，数据都是加密，就能防止别人的窥测了。至于具体的加密过程可以看<a href="http://cjting.me/web2.0/2016-09-05-从零开始搭建一个HTTPS网站.html" target="_blank" rel="noopener">这儿</a>。</p>
<h3 id="CA的证书"><a href="#CA的证书" class="headerlink" title="CA的证书"></a>CA的证书</h3><p>如果详细了解了加密的过程，就知道想用HTTPS就要一个CA（Certificate Authority, 权威机构）的证书，这个证书一般都是要购买的，而且一般都很贵，虽然也有便宜的，但像博主这种博客几乎没人看，域名都是免费的，又何必花钱买个证书，所以就用免费的吧。俗话说便宜没好货，一般免费的CA证书也有各种问题，在这里推荐使用<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>，来自Internet Security Research Group，算是个公益组织，其目的就是让大家都用上免费的HTTPS，先赞一个。</p>
<h3 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>首先说一下，博主的VPS是Debian 8，如果是其他版本的Linux要注意。</p>
<h4 id="安装客户端"><a href="#安装客户端" class="headerlink" title="安装客户端"></a>安装客户端</h4><p>Let’s Encrypt之前的官方客户端就叫<code>letsencrypt</code>，但是最近改名了，叫<code>certbot</code>. 要在Debian 8安装先要加backports源。具体看<a href="https://backports.debian.org/Instructions/" target="_blank" rel="noopener">官方教程</a>。<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aptitude <span class="keyword">install</span> certbot -t jessie-backports</span><br></pre></td></tr></table></figure></p>
<p>注意一下，在这自动安装<code>crontab</code>，并在<code>/etc/cron.d/certbot</code>里加入了一天<code>renew</code>两次的命令。因为生成的证书有效期只有三个月，所以要经常续签，官方便做了一个定期任务。</p>
<h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly --webroot -w /var/www/example -d example<span class="selector-class">.com</span> -d xxx<span class="selector-class">.example</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>
<p>期间会让你输入email做紧急联系方式。</p>
<p>其中<code>/var/www/example</code>是你网站的根目录，<code>example.com</code>和<code>xxx.example.com</code>是你的域名，注意Let’s Encrypt不支持Wildcard，也就是泛解析<code>*.example.com</code>，所以每一个次域名你都要加进去。<br>如果你有两个独立的server，比如<code>example.com</code>和<code>www.example.com</code>是你的主站，<code>...main_webroot/</code>是你主站的根目录，另外又有<code>xxx.example.com</code>（也可以是顶级域名）是你的其他站，比如博客或者什么的，其根目录是<code>...xxx_webroot/</code>，那么你一样可以只用一个证书，<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly --webroot -w ...main_webroot/ -d example<span class="selector-class">.com</span> -d www<span class="selector-class">.example</span><span class="selector-class">.com</span>  -w ...xxx_webroot/ -d xxx<span class="selector-class">.example</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure></p>
<p>注意，之所以要指定根目录，是因为<code>certbot</code>要在根目录下建一个隐藏的<code>.well-known/</code>，用来检测域名确实是你所有，所以要注意Nginx的设置不能把隐藏文件作为特殊文件处理。<br>不出意外，这个时候你能在<code>/etc/letsencrypt/live/example.com/</code>下找到证书了。</p>
<h4 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h4><p>修改你原来的nginx配置文件，<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">    listen	   <span class="number">80</span>;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    return <span class="number">301</span> https:<span class="comment">//$server_name$request_uri; # 重定向到https</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">    listen         <span class="number">443</span> ssl;</span><br><span class="line">    root <span class="meta-keyword">/var/</span>www/example; <span class="meta"># 网站根目录</span></span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+<span class="number">3</span>DES:RSA+<span class="number">3</span>DES:!MD5;</span><br><span class="line">    ssl_session_cache shared:SSL:<span class="number">10</span>m;</span><br><span class="line">    ssl_session_timeout  <span class="number">1</span>d;</span><br><span class="line">    ssl_certificate <span class="meta-keyword">/etc/</span>letsencrypt<span class="meta-keyword">/live/</span>example.com/fullchain.pem;</span><br><span class="line">    ssl_certificate_key <span class="meta-keyword">/etc/</span>letsencrypt<span class="meta-keyword">/live/</span>example.com/privkey.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="meta"># 其余的配置</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="开启HTTP-2"><a href="#开启HTTP-2" class="headerlink" title="开启HTTP/2"></a>开启HTTP/2</h4><p>HTTP/2有很多优势，可以看<a href="https://www.qianduan.net/a-simple-performance-comparison-of-https-spdy-and-http2/" target="_blank" rel="noopener">这儿</a>，所以可以开启了，不过要注意，Nginx只有1.9.5之上的版本支持HTTP/2。Debian 8下开以安装backports版的Nginx。<br>开启很简单，只需要在上面的配置<code>443 ssl;</code>后面添加<code>http2</code>变成<code>443 ssl http2;</code>即可。<br>然后<code>systemctl restart nginx</code>重启服务。</p>
<h4 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h4><p>如果你防火墙默认放过所有，跳过此步骤。<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m tcp --dport <span class="number">443</span> -m <span class="keyword">state</span> --state NEW -j ACCEPT</span><br></pre></td></tr></table></figure><br>然后用你自己的方法save一下保证重启不失效。</p>
<h4 id="配置crontab"><a href="#配置crontab" class="headerlink" title="配置crontab"></a>配置crontab</h4><p>前面说了，证书三个月到期，所以要定期刷新，官方已经给你建好了任务文件，只需要指向它就可以了。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="regexp">/etc/</span>cron.d<span class="regexp">/certbot</span></span><br></pre></td></tr></table></figure></p>
<p>至此你再打开你的网站，如果前面显示绿锁就OK了，然后你可以到<a href="https://tools.keycdn.com/http2-test" target="_blank" rel="noopener">https://tools.keycdn.com/http2-test</a>测试你的网站有没有成功开启HTTP/2。</p>
<h3 id="后续处理"><a href="#后续处理" class="headerlink" title="后续处理"></a>后续处理</h3><p>然后记得，去<a href="https://www.google.com/webmasters/tools/" target="_blank" rel="noopener">Google Search Console</a>添加HTTPS，去<a href="http://zhanzhang.baidu.com" target="_blank" rel="noopener">百度站长</a>设置HTTPS，如果你用了LeanCloud计数，还要去<a href="https://leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a>修改域名绑定。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://certbot.eff.org/#debianjessie-nginx" target="_blank" rel="noopener">https://certbot.eff.org/#debianjessie-nginx</a></li>
<li><a href="https://blog.ishell.me/a/Lets-Encrypt-and-HTTP2.html" target="_blank" rel="noopener">https://blog.ishell.me/a/Lets-Encrypt-and-HTTP2.html</a></li>
</ol>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>shengdie</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2016/10/27/nginx-htts2/">http://shengdie.github.io/2016/10/27/nginx-htts2/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://shengdie.github.io/2016/10/27/nginx-htts2/" data-id="cjw1wvinp0014hpp1l0kmxb1e" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACL0lEQVR42u3aQXKDMBAEQP//005VTkk5xjMSToLUOlGAgdZhrd3V7RaP++d4PPP1/OPx4z3HT07unxoYGBiXZdwPx7OXJR+UvCWZmuS3GBgYOzDaUHgcHGfY7W8xMDAwju85XggmATQ5j4GBgdEG3Hwcg9vgi4GBgZEksUma2lbD2kB8Qi6OgYFxQUbbGPjN4zf2NzAwMC7COGuplwfcZIFYfxUGBsbSjHaRlySfyfaLmfbD08nCwMBYlJFvfcivtqlmvkXj6YRiYGBswMg/fSajPCvnLhaFGBgYSzDazRNta7NNYvMFaDQRGBgYSzDaNmSyKJzfYJE/DQMDY2dGm5SObZLIC3MvJgIDA2MDRl6OHyu6zSxAk6sYGBhrM8Ye1yau7XTk6SsGBsY+jLHRBt+xVgQGBgZGWyZrU9Ox8lw+Wbe2PoeBgXFBxljPcyYszpfhnubiGBgY2zDyItpfBd/BfwwMDIzLMmaK+Mn9x2E3f8vx/RgYGDswBhdkQ+W5HDMYoDEwMJZjvOPReerbbr/41RnCwMD4Z4x2G0QegttSWnL1ByoGBsbSjJkktk1xkzPtnwQGBsYOjHs5ktA81mBop+zbMQYGxtKMNsy1pf+ZkDrTYMDAwFiPcda2ibzp+JYNGRgYGBswxjZMjIXUsVT2xWIUAwMDIyblyWcbxF9MHwYGBkb8WTOLwql3YWBgbMCYaQa0C8c2lU3OY2BgrM2YSTXPAs80QTEwMJZmfACeABkGG7mWngAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/VPS/">VPS</a></div><div class="post-nav"><a class="pre" href="/2016/11/02/linux-rename/">Linux 批量重命名带空格的文件</a><a class="next" href="/2016/10/25/webdave-nginx/">Debian用Nginx搭建Webdav server</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '37417accc6643f52f078',
  clientSecret: '7d3c30381c31a16ec1a64078086acd9cf35c0166',
  repo: 'QingtianComments',
  owner: 'shengdie',
  admin: ['shengdie'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://shengdie.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Physics/">Physics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TePUB/">TePUB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/boosayy/">书声</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/websites/">网站</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/dao/">道</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/boosayy/" style="font-size: 15px;">书声</a> <a href="/tags/TePUB/" style="font-size: 15px;">TePUB</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/Emacs/" style="font-size: 15px;">Emacs</a> <a href="/tags/Latex/" style="font-size: 15px;">Latex</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/VPS/" style="font-size: 15px;">VPS</a> <a href="/tags/ShellCommands/" style="font-size: 15px;">ShellCommands</a> <a href="/tags/QuantumField/" style="font-size: 15px;">QuantumField</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/shuimian-dao/">【转】利用睡眠修习禅定</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/vnc-linux/">Linux设置VNC服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/25/libai/">如果没有李白</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/09/abaqus-singularity/">Manjaro借助singularity安裝abaqus 2018</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/TePUB-Help/">TePUB使用教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/Win-Emacs-lag/">解决Windows下Emacs Unicode字符爆卡的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/29/Mac-Emacs-Skim/">Mac下配置Emacs+AucTex+Skim</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/08/googleBBR/">BBR阻塞算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/Boosayy-help/">书声使用帮助</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/08/ffmpeg-nvenc/">ffmpeg用GPU转码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">晴天.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>